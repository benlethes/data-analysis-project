<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Analysis Project: Sound Visualization</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.7.0/addons/p5.sound.min.js"></script>
</head>
<body>

    <!-- Title bar in normal document flow — never overlaps canvas -->
    <div id="top-bar">
        <h1>Data Analysis Project: Sound Visualization</h1>
        <div style="display:flex; gap:10px;">
            <button id="info-btn" class="btn-icon" aria-label="About this project">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                </svg>
                Info
            </button>
            <button id="fullscreen-trigger" class="btn-icon">
                <svg viewBox="0 0 24 24">
                    <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                </svg>
                Fullscreen
            </button>
        </div>
    </div>

    <!-- Floating exit — only shown when fullscreen is active (CSS class) -->
    <button id="exit-fs-btn">
        <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
            <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>
        </svg>
        Exit Fullscreen
    </button>

    <div id="canvas-container"></div>
    <div id="audio-debug">AUDIO CONTEXT SUSPENDED</div>

    <div id="controls-bar">

        <!-- 01. Input Source -->
        <div class="control-group">
            <div class="label">01. Input Source</div>
            <select id="audioSource">
                <option value="upload" selected>Upload File</option>
                <option value="demo1">Demo: Classical</option>
                <option value="demo2">Demo: Electronic</option>
                <option value="mic">Microphone (Live)</option>
            </select>
            <div id="uploadGroup" class="upload-container visible">
                <div class="file-upload">
                    <button style="width:100%">Select Audio File</button>
                    <input type="file" id="audioFile" accept="audio/*">
                </div>
            </div>
            <div id="fileName">Waiting for input...</div>
        </div>

        <!-- 02. Transport -->
        <div class="control-group">
            <div class="label">02. Transport</div>
            <div style="display:flex; gap:10px;">
                <button id="playBtn" disabled>Play</button>
                <button id="pauseBtn" disabled>Pause</button>
                <button id="stopAudioBtn" disabled>Stop</button>
                <button id="resetBtn">Clear</button>
            </div>
            <div id="playback-info">System Ready</div>
        </div>

        <!-- 03. Visualization + background toggle (always visible) -->
        <div class="control-group">
            <div class="label">03. Visualization</div>
            <select id="vizStyle">
                <option value="waveform">A. Waveform (Standard)</option>
                <option value="optical">B. Optical Flow (3D Lines)</option>
                <option value="architect">C. Architect (Structure)</option>
                <option value="paint">D. Color Blend (Paint)</option>
                <option value="spectrogram">E. Spectrogram (Frequency/Time)</option>
                <option value="rimington">F. Rimington (Color Organ)</option>
            </select>
            <!-- Background toggle — applies to all visualizations -->
            <div class="option-toggle">
                <input type="checkbox" id="bgToggle" style="accent-color:var(--accent);">
                <label for="bgToggle" class="toggle-label">Dark background</label>
            </div>
        </div>

        <!-- 04. Color Palette + conditional per-viz toggles -->
        <div class="control-group">
            <div class="label">04. Color Palette</div>
            <select id="colorScheme">
                <option value="bauhaus">Bauhaus (Primary)</option>
                <option value="neon">Cyber (Neon/Dark)</option>
                <option value="monochrome">Carbon (Greyscale)</option>
                <option value="sunset">Sunset (Warm)</option>
                <option value="ocean">Ocean (Cool)</option>
                <option value="earth">Earth (Natural)</option>
                <option value="midnight">Midnight (Deep)</option>
            </select>

            <!-- Shown only for Spectrogram -->
            <div id="spectrogramAxesGroup" class="option-toggle" style="display:none;">
                <input type="checkbox" id="spectrogramAxesToggle" checked
                       style="accent-color:var(--accent);">
                <label for="spectrogramAxesToggle" class="toggle-label">Show frequency axes</label>
            </div>

            <!-- Shown only for Rimington -->
            <div id="legendToggleGroup" class="option-toggle" style="display:none;">
                <input type="checkbox" id="legendToggle" checked
                       style="accent-color:var(--accent);">
                <label for="legendToggle" class="toggle-label">Show note legend</label>
            </div>
        </div>

        <!-- 05. Reactivity -->
        <div class="control-group" style="border-right:none;">
            <div class="label">05. Reactivity</div>
            <input type="range" id="intensitySlider" min="0" max="100" value="50">
            <div style="display:flex; justify-content:space-between; font-size:0.6rem; margin-top:2px;">
                <span>Subtle</span>
                <span>Extreme</span>
            </div>
        </div>

    </div>

    <!-- ══════════════════════════════════════════════════════
         WELCOME MODAL — shown on first load, dismissed by user
         ══════════════════════════════════════════════════════ -->
    <div id="welcome-overlay">
      <div id="welcome-modal" role="dialog" aria-modal="true" aria-labelledby="welcome-heading">

        <!-- Close × -->
        <button id="welcome-close" aria-label="Close">
            <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>

        <div id="welcome-modal-inner">

          <div class="welcome-title" id="welcome-heading">Sound Visualization</div>
          <div class="welcome-subtitle">Data Analysis Project &nbsp;·&nbsp; University of Vienna</div>

          <!-- About -->
          <div class="welcome-section-title">About</div>
          <p class="welcome-body">
            This tool transforms audio into real-time visual art. Upload a track, use a demo,
            or plug in your microphone — then watch the music become color, shape, and motion.
            Each visualization mode reacts differently to bass, mid, and treble frequencies.
          </p>

          <!-- How to use -->
          <div class="welcome-section-title">How to use</div>
          <ol class="welcome-steps">
            <li><strong>Choose an input</strong> — upload an audio file, pick a demo track, or select Microphone.</li>
            <li><strong>Press Play</strong> (or "Start Mic") to begin.</li>
            <li><strong>Pick a visualization</strong> from the dropdown — each one responds to sound differently.</li>
            <li><strong>Adjust the palette, background and reactivity</strong> to your taste.</li>
            <li><strong>Hit Fullscreen</strong> for the full experience. Hover the top-right corner to exit.</li>
          </ol>

          <!-- Visualizations -->
          <div class="welcome-section-title">Visualization Modes</div>
          <div class="welcome-viz-grid">
            <div class="welcome-viz-item">
              <span class="welcome-viz-name">A · Waveform</span>
              <span class="welcome-viz-desc">Classic oscilloscope — raw audio signal drawn across the canvas.</span>
            </div>
            <div class="welcome-viz-item">
              <span class="welcome-viz-name">B · Optical Flow</span>
              <span class="welcome-viz-desc">Flowing lines distorted by bass and mid frequencies.</span>
            </div>
            <div class="welcome-viz-item">
              <span class="welcome-viz-name">C · Architect</span>
              <span class="welcome-viz-desc">Accumulating geometric lines and flashes that build over time.</span>
            </div>
            <div class="welcome-viz-item">
              <span class="welcome-viz-name">D · Color Blend</span>
              <span class="welcome-viz-desc">Overlapping painted rectangles driven by volume and treble.</span>
            </div>
            <div class="welcome-viz-item">
              <span class="welcome-viz-name">E · Spectrogram</span>
              <span class="welcome-viz-desc">Scrolling time–frequency map. Bass at bottom, treble at top.</span>
            </div>
            <div class="welcome-viz-item">
              <span class="welcome-viz-name">F · Rimington</span>
              <span class="welcome-viz-desc">Historical color-organ: each musical note maps to a spectrum color.</span>
            </div>
          </div>

          <!-- Options -->
          <div class="welcome-section-title">Options</div>
          <p class="welcome-body">
            <strong>Color Palette</strong> — 7 schemes (Bauhaus, Cyber, Carbon, Sunset, Ocean, Earth, Midnight).<br>
            <strong>Dark / Light background</strong> — switch for any visualization.<br>
            <strong>Reactivity</strong> — from subtle to extreme visual response.<br>
            <strong>Pause</strong> — freezes the canvas as a snapshot.<br>
            <strong>Show/hide axes</strong> (Spectrogram) and <strong>note legend</strong> (Rimington).
          </p>

          <!-- Footer -->
          <div class="welcome-footer">
            <div class="welcome-byline">
              Have fun exploring!<br>
              <strong>— Ben Seegatz</strong><br>
              <span style="font-size:0.65rem; color:#aaa;">Data Analysis Project · University of Vienna</span>
            </div>
            <button id="welcome-start">Let's go →</button>
          </div>

        </div><!-- /inner -->
      </div><!-- /modal -->
    </div><!-- /overlay -->

    <!-- ══════════════════════════════════════════════════════
         MOBILE AUDIO UNLOCK OVERLAY
         Shown only on iOS / Android after the welcome modal.
         A direct tap is the only reliable way to unlock the
         Web Audio API on mobile browsers.
         ══════════════════════════════════════════════════════ -->
    <div id="mobile-audio-overlay" style="display:none;">
        <div id="mobile-audio-prompt">
            <div id="mobile-audio-icon">
                <svg viewBox="0 0 24 24" width="44" height="44" fill="white">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                </svg>
            </div>
            <p id="mobile-audio-title">Tap to enable audio</p>
            <p id="mobile-audio-sub">Mobile browsers require a tap before<br>sound can play. This only happens once.</p>
        </div>
    </div>

    <style>
        /* ── Mobile audio unlock overlay ── */
        #mobile-audio-overlay {
            position: fixed;
            inset: 0;
            z-index: 800;          /* above canvas, below welcome modal (900) */
            background: rgba(0, 0, 0, 0.82);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            animation: mobileOverlayIn 0.35s ease both;
        }
        @keyframes mobileOverlayIn {
            from { opacity: 0; }
            to   { opacity: 1; }
        }
        #mobile-audio-overlay.hiding {
            animation: mobileOverlayOut 0.3s ease both;
        }
        @keyframes mobileOverlayOut {
            from { opacity: 1; }
            to   { opacity: 0; }
        }
        #mobile-audio-prompt {
            text-align: center;
            color: white;
            padding: 2rem;
            pointer-events: none;  /* let clicks pass through to overlay */
        }
        #mobile-audio-icon {
            width: 88px;
            height: 88px;
            margin: 0 auto 1.2rem;
            background: rgba(255,255,255,0.12);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: mobilePulse 1.6s ease-in-out infinite;
        }
        @keyframes mobilePulse {
            0%, 100% { transform: scale(1);    box-shadow: 0 0 0 0   rgba(255,255,255,0.3); }
            50%       { transform: scale(1.07); box-shadow: 0 0 0 18px rgba(255,255,255,0);   }
        }
        #mobile-audio-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0 0 0.5rem;
            letter-spacing: 0.02em;
        }
        #mobile-audio-sub {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.65);
            margin: 0;
            line-height: 1.5;
        }
    </style>

    <script>
      // ── Welcome modal ──────────────────────────────────────────
      function closeWelcome() {
          var overlay = document.getElementById('welcome-overlay');
          overlay.classList.add('hiding');
          overlay.addEventListener('animationend', function() {
              overlay.style.display = 'none';
              // After welcome closes, show the mobile audio prompt if needed
              showMobileAudioOverlayIfNeeded();
          }, { once: true });
      }
      function openWelcome() {
          var overlay = document.getElementById('welcome-overlay');
          overlay.style.display = 'flex';
          overlay.classList.remove('hiding');
      }
      document.getElementById('welcome-close').addEventListener('click', closeWelcome);
      document.getElementById('welcome-start').addEventListener('click', closeWelcome);
      document.getElementById('info-btn').addEventListener('click', openWelcome);
      document.getElementById('welcome-overlay').addEventListener('click', function(e) {
          if (e.target === this) closeWelcome();
      });

      // ── Mobile audio unlock ────────────────────────────────────
      var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
      var audioContextUnlocked = false;

      function showMobileAudioOverlayIfNeeded() {
          if (!isMobile || audioContextUnlocked) return;
          var mo = document.getElementById('mobile-audio-overlay');
          mo.style.display = 'flex';
      }

      // Core unlock: called on any tap of the mobile overlay.
      // Must be synchronous and directly inside the event handler
      // so iOS treats it as a trusted gesture.
      function doAudioUnlock() {
          audioContextUnlocked = true;

          // 1. p5.js helper — unlocks p5's own AudioContext
          if (typeof userStartAudio === 'function') {
              try { userStartAudio(); } catch(e) {}
          }

          // 2. Resume p5's AudioContext directly
          if (typeof getAudioContext === 'function') {
              try { getAudioContext().resume(); } catch(e) {}
          }

          // 3. Belt-and-suspenders: play a 1-sample silent buffer.
          //    This is the canonical iOS Web Audio unlock trick — it
          //    marks the context as "started by user gesture" even if
          //    p5 isn't fully initialised yet.
          try {
              var AC = window.AudioContext || window.webkitAudioContext;
              if (AC) {
                  var ctx = new AC();
                  var buf = ctx.createBuffer(1, 1, 22050);
                  var src = ctx.createBufferSource();
                  src.buffer = buf;
                  src.connect(ctx.destination);
                  src.start(0);
                  ctx.resume();
              }
          } catch(e) {}

          // Fade out and hide the overlay
          var mo = document.getElementById('mobile-audio-overlay');
          mo.classList.add('hiding');
          mo.addEventListener('animationend', function() {
              mo.style.display = 'none';
          }, { once: true });
      }

      var mobileOverlay = document.getElementById('mobile-audio-overlay');
      mobileOverlay.addEventListener('click',      doAudioUnlock);
      mobileOverlay.addEventListener('touchstart', doAudioUnlock, { passive: true });
    </script>

    <script src="sketch.js"></script>
</body>
</html>